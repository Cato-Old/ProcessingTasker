package View.GUI;import Controller.Controller;import Model.Projects.Project;import Model.Projects.ProjectItem;import Model.Projects.Publications.Publication;import View.View;import javafx.scene.control.*;import javafx.scene.layout.HBox;import javafx.scene.layout.Pane;import javafx.scene.layout.VBox;import java.util.List;import java.util.Map;import java.util.stream.Collectors;import static javafx.scene.layout.Priority.ALWAYS;public class PublicationTree{    private Controller controller;    private Menu menu; private  Tree tree; private MenuOnClick menuOnClick;    public PublicationTree(Controller controller) {        this.controller = controller;        menu = new Menu();        tree = new Tree();        menuOnClick = new MenuOnClick();    }    class Menu{        HBox box;        Button addProject = new Button("Add project");        Button remProject = new Button("Remove project");        Project selected;        void create(){            addProject.setOnAction(evt -> {                try {                    controller.addProject(controller.chooseDir());                } catch (IllegalArgumentException ignore){}            });            remProject.setOnAction(evt -> {                controller.remProject(selected);                selected = null;            });            remProject.setDisable(true);            addProject.setPrefWidth(200);            remProject.setPrefWidth(200);            HBox.setHgrow(addProject, ALWAYS);            HBox.setHgrow(remProject, ALWAYS);            this.box = new HBox(addProject, remProject);        }    }    class Tree{        TreeView<ProjectItem> pubTreeView;        void create(List<Project> projects){            TreeItem<ProjectItem> root = createRoot(projects);            TreeView<ProjectItem> pubTreeView = new TreeView<>(root);            pubTreeView.setShowRoot(false);            pubTreeView.getSelectionModel().selectedItemProperty().addListener((observable, oldValue, newValue) -> {                if (newValue == null) {                    menu.remProject.setDisable(true);                    menuOnClick.remPub.setDisable(false);                    controller.selProject(null);                } else if (newValue.getValue() instanceof Project) {                    controller.selProject((Project) newValue.getValue());                    menu.remProject.setDisable(false);                    menu.selected = (Project) newValue.getValue();                    menuOnClick.remPub.setDisable(true);                    menuOnClick.addPub.setDisable(false);                    menuOnClick.selProject = newValue;                } else {                    controller.selPub((Publication) newValue.getValue());                    menu.remProject.setDisable(true);                    menuOnClick.addPub.setDisable(true);                    menuOnClick.remPub.setDisable(false);                    menuOnClick.selPub = (Publication) newValue.getValue();                    menuOnClick.selProject = newValue.getParent();                }            });            pubTreeView.setContextMenu(menuOnClick.create());            menuOnClick.remPub.setDisable(true);            menuOnClick.addPub.setDisable(true);            this.pubTreeView = pubTreeView;        }        void update(List<Project> projects){            TreeItem<ProjectItem> root = pubTreeView.getRoot();            Map<Project,Boolean> expanded = root.getChildren()                    .stream()                    .collect(Collectors.toMap(                            p -> (Project) p.getValue(),                            TreeItem::isExpanded));            root = createRoot(projects);            Map<Project,TreeItem<ProjectItem>> newTreeItems = root.getChildren()                    .stream()                    .collect(Collectors.toMap(                            p -> (Project) p.getValue(),                            p -> p));            for (Project p : newTreeItems.keySet()){                if (expanded.get(p) != null){                    newTreeItems.get(p).setExpanded(expanded.get(p));                }            }            pubTreeView.setRoot(root);            menuOnClick.remPub.setDisable(true);            menuOnClick.addPub.setDisable(true);        }        private TreeItem<ProjectItem> createRoot(List<Project> projects) {            List<TreeItem<ProjectItem>> pubTree = projects.stream()                    .map(p -> {                        TreeItem<ProjectItem> treeItem = new TreeItem<>(p);                        treeItem.getChildren().addAll(                                p.getPublications()                                        .stream()                                        .map(TreeItem<ProjectItem>::new)                                        .collect(Collectors.toList()));                        return treeItem;})                    .collect(Collectors.toList());            TreeItem<ProjectItem> root = new TreeItem<>();            root.getChildren().addAll(pubTree);            return root;        }    }    class MenuOnClick{        MenuItem addPub = new MenuItem("Add publication");        MenuItem remPub = new MenuItem("Remove publication");        TreeItem<ProjectItem> selProject;        Publication selPub;        ContextMenu create(){            ContextMenu contextMenu = new ContextMenu();            addPub.setOnAction(evt -> {                Project project = (Project) selProject.getValue();                selProject.setExpanded(true);                try {                    controller.addPub(project, controller.chooseDir(project.getSourcePath()));                } catch (IllegalArgumentException ignore) { }            });            remPub.setOnAction(evt -> controller.remPub(selPub.getProject(), selPub));            contextMenu.getItems().addAll(addPub, remPub);            return contextMenu;        }    }    public Pane create(List<Project> projects){        tree.create(projects);        menu.create();        VBox box = new VBox(tree.pubTreeView, menu.box);        box.setFillWidth(true);        VBox.setVgrow(tree.pubTreeView,ALWAYS);        return box;    }    public void update(List<Project> projects){        tree.update(projects);    }    public TreeView<ProjectItem> getTreeView(){        return tree.pubTreeView;    }}